var logged = false;
window.onload = function(){

	loadHomeView();
	
	if(logged == false){
		$("#navbar").hide();
	}
	else{
		$("#navbar").show();};

		document.getElementById("homePage")
		.addEventListener("click", loadDashboardView);

		document.getElementById("accPage")
		.addEventListener("click", loadAccountPageView);


};


function loadHomeView(){
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
		if(xhr.readyState == 4 && xhr.status == 200){
			//console.log(xhr.responseText);
			document.getElementById('view').innerHTML = xhr.responseText;		
			document.getElementById("login")
				.addEventListener("click", login);
		}
	}
	console.log("getting homepage")
	xhr.open("GET", "getLoginView", true);
	xhr.send();
};


function login(){
	var email = document.getElementById("email").value;
	var pass = document.getElementById("pass").value;
	var tx = [email, pass];
	tx = JSON.stringify(tx);

	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
		if(xhr.readyState == 4 && xhr.status == 200){
			var response =  xhr.responseText;

			if (response == "fail"){
				document.getElementById("message")
				.innerHTML = "Invalid credentials. Please try again";
			}
			else if(response == "pass"){
				document.getElementById("message")
				.innerHTML = "Invalid user. Please try again";
			}
			else{
				logged = true;
				console.log(response);
				loadDashboardView();
				$("#navbar").show();
			}
		}
	}

	xhr.open("POST", "login", true);
	xhr.setRequestHeader("Content-type",
	"application/x-www-form-urlencoded");
	xhr.send(tx);
};


function loadDashboardView(){
	console.log("in load dashboard view");
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
		if(xhr.readyState == 4 && xhr.status == 200){
			document.getElementById('view').
			innerHTML = xhr.responseText;
			getUserPageInfo(); // loads user info by calling function

		}
	}
	console.log("getting dash");
	xhr.open("GET", "getDashboard", true);
	xhr.send();
};




function loadReimbursmentPageView(){
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
		if(xhr.readyState == 4 && xhr.status == 200){
			document.getElementById('view').
			innerHTML = xhr.responseText;
			getReimbursmentPageInfo(); // loads user info by calling function
			
		}
	}
	console.log("getting user reimbursments")
	xhr.open("GET", "getRemPage", true);
	xhr.send();
}

function getReimbursmentPageInfo(){ // loads basic user info and account info into html
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
		if(xhr.readyState == 4 && xhr.status == 200){
			console.log(xhr.responseText);
			var dto = JSON.parse(xhr.responseText);
			var user = dto.user;
			var rem = dto.reimbursements;


			if (rem.length == 0){
				document.getElementById("reimbursements").style.visibility = "hidden"; 

			}
			else{
// create reimbursement table
//	 
				  var table="<thead><th>ID</th><th>Amount</th><th>Description</th><th>Submitted</th></thead>";
				  var table2="<thead><th>ID</th><th>Amount</th><th>Description</th><th>Reason</th></thead>";
				  var table3="<thead><th>ID</th><th>Amount</th><th>Description</th><th>Reason</th></thead>";
				  for (i = 0; i <user_info.reimbursements.length; i++) { 
					var add = "";
				    add +="<tr><td>";
					  
				    add += user_info.reimbursements[i].reimbursementId +"</td><td>$";
				    
				    add += user_info.reimbursements[i].amount +"</td><td>";
				    
				    if(user_info.reimbursements[i].description != null){
				    	add += user_info.reimbursements[i].description +"</td><td>";
				    }
				    else{
				    	add += "</td><td>";
				    }
				    
				    if(user_info.reimbursements[i].statusId == 0){
				    	var date = new Date(parseInt(user_info.reimbursements[i].submitDate));
					    add += date.toLocaleDateString() + "</td></tr>";
					    table += add;
				    }
				    else{
					    if(user_info.reimbursements[i].managerNotes != null){
					    	add += user_info.reimbursements[i].managerNotes +"</td></tr>";
					    }
					    else{
					    	add += "</td></tr>";
					    }
					    
					    if(user_info.reimbursements[i].statusId == 1){
					    	table2 += add;
					    }
					    else{
					    	table3 += add;
					    }
				    }
				  }
				  if(user_info.reimbursements.length==0){
					  document.getElementById("pending-table").style.visibility = "hidden";
					  document.getElementById("approved-table").style.visibility = "hidden";
					  document.getElementById("denied-table").style.visibility = "hidden";
				  }
				  else{
					  document.getElementById("pending-table").innerHTML = table;
					  document.getElementById("approved-table").innerHTML = table2;
					  document.getElementById("denied-table").innerHTML = table3;
					  
				  }
			}

			window.onload = function(){
				getInfo();
			}
	xhr.open("GET", "getUserInfo", true);
	xhr.send();
	
}


function getUserPageInfo(){ // loads basic user info and account info into html
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
		if(xhr.readyState == 4 && xhr.status == 200){
			console.log(xhr.responseText);
			var someUser = JSON.parse(xhr.responseText);
			var user = someUer.user;
			document.getElementById('name').innerHTML = user.firstname + " " + user.lastname;
		}
	}
	xhr.open("GET", "getUserInfo", true);
	xhr.send();

};


//
//function addUser(){ // allows us to acc new accounts 
//	var accType = document.getElementById("accType").value;
//	console.log(accType);
//
//	var type = JSON.stringify(accType);
//
//	var xhr = new XMLHttpRequest();
//	xhr.onreadystatechange = function(){
//		if(xhr.readyState == 4 && xhr.status == 200){
//			console.log(xhr.responseText);
//
//		}
//	}
//
//	xhr.open("POST", "addAccount", true);
//	//set the header to tell the server you have data for it to process
//	xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");//research this !!!
//	xhr.send(input); //include your post data in the send()
//
//}

function addRemibursement(){ // allows us to add new reimbursements 
	var rem = document.getElementbyId("addRem").action;
	console.log(rem);

	var type = JSON.stringify(rem);

	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
		if(xhr.readyState == 4 && xhr.status == 200){
			console.log(xhr.responseText);

		}
	}

	xhr.open("POST", "addReimbursement" , true);
	//set the header to tell the server you have data for it to process
	xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");//research this !!!
	xhr.send(input); //include your post data in the send()

}

