package com.ex.dao;

import java.sql.CallableStatement;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Types;
import java.util.ArrayList;

import java.util.Date;

import com.bank.pojos.*;
import com.ex.util.SingleConnection;

// NOTE: SQL is 1-indexed rather than 0-indexed

public class DaoSqlImpl implements DaoSql {
	
	public String getFormatedDate(Date day) {
		String result = "";
		
		result += day.getYear() + '-';
		result += day.getMonth() + '-';
		result += day.getDay();
		
		return result;
	}
	
	/*
	 * Prepared Statement
	 */
	public boolean createPerson(Person per) {

		try(Connection conn = SingleConnection.getInstance().getConnection()) {
			conn.setAutoCommit(false);

			// No semi-colon inside the quotes
			String sql = "INSERT INTO person(ssn, first_name, last_name, email, birth_date, deceased)" + 
					" VALUES(?, ?, ?, ?, TO_DATE(?,'yyyy-mm-dd'), ?);";
			String[] key = new String[1];
			key[0] = "ex_id";

			PreparedStatement prep = conn.prepareStatement(sql, key);
			prep.setInt(1, per.getSSN());
			prep.setString(2, per.getFirstName());
			prep.setString(3, per.getLastName());
			prep.setString(4, per.getEmail());
			prep.setString(5, getFormatedDate(per.getBirthDate()));
			prep.setInt(6, per.isDeceased()?1:0);

			// executeUpdate() returns the number of rows updated
			prep.executeUpdate();
			ResultSet pk = prep.getGeneratedKeys();

			// Use a while loop even though I only expect one result
			while(pk.next()) {
			}

			conn.commit();
			return true;

		} catch (SQLException e) {
			e.printStackTrace();
		}

		// Something went wrong
		return false;

	}

	public ArrayList<Example> getAll() {
		ArrayList<Example> whateverFloatsYourBoat = new ArrayList<Example>();

		try(Connection conn = SingleConnection.getInstance().getConnection()) {

			String sql = "SELECT * from example";
			Statement statement = conn.createStatement();
			ResultSet rs = statement.executeQuery(sql);

			while(rs.next()) {
				int id = rs.getInt(1);
				String firstName = rs.getString(2);
				String lastName = rs.getString(3);
				int song_id = rs.getInt(4);

				whateverFloatsYourBoat.add(new Example(id, firstName, lastName, song_id));
			}
		} catch (SQLException e) {
			e.printStackTrace();
		}

		return whateverFloatsYourBoat;
	}

	public ArrayList<Example> getAllWithTitle() {
		ArrayList<Example> whateverFloatsYourBoat = new ArrayList<Example>();

		try(Connection conn = SingleConnection.getInstance().getConnection()) {

			String sql = "SELECT ex.ex_id, ex.firstname, ex.lastname, tr.name" + 
					" FROM example ex" + 
					" LEFT JOIN track tr" + 
					" ON ex.favorite_song_id = tr.trackid";
			Statement statement = conn.createStatement();
			ResultSet rs = statement.executeQuery(sql);

			while(rs.next()) {
				Example exp = new Example();
				exp.setId(rs.getInt(1));
				exp.setFirstName(rs.getString(2));
				exp.setLastName(rs.getString(3));
				exp.setSongName(rs.getString(4));

				whateverFloatsYourBoat.add(exp);
			}
		} catch (SQLException e) {
			e.printStackTrace();
		}

		return whateverFloatsYourBoat;
	}

	@Override
	public boolean createPerson(Person per) {
		// TODO Auto-generated method stub
		return false;
	}

	@Override
	public Person readPerson(int SSN) {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public boolean readPerson(String email) {
		// TODO Auto-generated method stub
		return false;
	}

	@Override
	public boolean updatePerson(Person per) {
		// TODO Auto-generated method stub
		return false;
	}

	@Override
	public boolean deletePerson(String SSN, boolean erase) {
		// TODO Auto-generated method stub
		return false;
	}

	@Override
	public ArrayList<Person> readAllPersons() {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public boolean createBankUser(BankUser guy) {
		// TODO Auto-generated method stub
		return false;
	}

	@Override
	public BankUser readBankUser(String username) {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public BankUser readBankUser(int userId) {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public boolean updateBankUser(BankUser guy) {
		// TODO Auto-generated method stub
		return false;
	}

	@Override
	public boolean deleteBankUser(int userId, boolean erase) {
		// TODO Auto-generated method stub
		return false;
	}

	@Override
	public ArrayList<BankUser> readAllUsers() {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public boolean createAccount(Account acc) {
		// TODO Auto-generated method stub
		return false;
	}

	@Override
	public Person readAccount(int accountId) {
		// TODO Auto-generated method stub
		return null;
	}

	@Override
	public boolean updateAccount(Account acc) {
		// TODO Auto-generated method stub
		return false;
	}

	@Override
	public boolean deleteAccount(int accountId, boolean erase) {
		// TODO Auto-generated method stub
		return false;
	}

	@Override
	public ArrayList<Person> readAllAccounts() {
		// TODO Auto-generated method stub
		return null;
	}


}
