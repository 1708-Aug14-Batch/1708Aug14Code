package com.reimburse.dao;

import java.math.BigDecimal;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;
import java.util.Date;
import java.util.HashMap;

import com.reimburse.pojos.Reimbursement;
import com.reimburse.pojos.User;
import com.reimburse.util.ConnectionUtil;

public class SystemDAOImpl implements SystemDAO{
	
	public HashMap<Integer, String> getEmails(){
		HashMap<Integer, String> emails = new HashMap<Integer, String>();
		
		try(Connection conn = ConnectionUtil.getConnection();){
			String sql = "select userid, email from users";
			Statement statement = conn.createStatement();
			ResultSet rs = statement.executeQuery(sql);
			
			while(rs.next()){
				int id = rs.getInt(1);
				String email = rs.getString(2);
				emails.put(id, email);
			}
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return emails;
		
		
	}
	
	public User getUserById(int id) {
		User u = new User();
		try(Connection conn = ConnectionUtil.getConnection();){
			String sql = "select * from users where userId = ?";
			PreparedStatement ps = conn.prepareStatement(sql);
			ps.setInt(1, id);
			ResultSet info = ps.executeQuery();
			
			while(info.next()){
				u.setUserid(info.getInt(1));
				u.setFirstName(info.getString(2));
				u.setLastName(info.getString(3));
				u.setEmail(info.getString(4));
				u.setPassword(info.getString(5));
			}
		} catch (SQLException e) {			
			e.printStackTrace();
		}
				
				
		return u;
	}

	
	public int addUser(String firstname, String lastname, String email, String pwd) {
		
		try(Connection conn = ConnectionUtil.getConnection();){
			conn.setAutoCommit(false);
			
			String sql = "insert into users" 
							+ "(firstname, lastname, email, password) "
							+ "values(?,?,?,?)";
			String [] key = new String[1];
			key[0] = "userid";
			PreparedStatement ps = conn.prepareStatement(sql, key);
			ps.setString(1, firstname);
			ps.setString(2, lastname);
			ps.setString(3, email);
			ps.setString(4, pwd);
			
			ps.executeUpdate();
			int id = 0;
			ResultSet pk = ps.getGeneratedKeys();
			while(pk.next()){
				id = pk.getInt(1);				
			}
			conn.commit();
			return id;
			
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}


		return 0;
	}

	
	public Reimbursement addReimbursement(User u, String desc, double amt) {
		Reimbursement r = null;
		try(Connection conn = ConnectionUtil.getConnection();){
			conn.setAutoCommit(false);
			String sql = "insert into reimbursement(submitterId, description,amount)"
					+" values(?,?,?)"; 
			String[] key = new String[1];
			key[0] = "reimId";
			PreparedStatement ps = conn.prepareStatement(sql,key);
			ps.setInt(1,u.getUserid());
			ps.setString(2, desc);
			ps.setDouble(3, amt);
			ps.executeUpdate();
			int id = 0;
			ResultSet pk = ps.getGeneratedKeys();
			while(pk.next()){
				id = pk.getInt(1);
			}
			r.setReimbursementID(id);
			conn.commit();
			
			
		} catch (SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
		
		return r;
	}
	public ArrayList<Reimbursement> getReimburseByUser(User u){
		ArrayList<Reimbursement> reimburse = new ArrayList<Reimbursement>();
		
		try(Connection conn = ConnectionUtil.getConnection();){
			String sql = "select r.reimId, r.description, r.amount, s.name as Status "
					+ "from reimbursements r inner join users on users.userid = r.submitterid"
					+ " inner join status s on s.statusid = r.statusid where users.userid = ?";
			PreparedStatement ps = conn.prepareStatement(sql);
			ps.setInt(1, u.getUserid());
			ResultSet info = ps.executeQuery();
			while(info.next()){
				Reimbursement temp = new Reimbursement();
				temp.setReimbursementID(info.getInt(1));
				temp.setAmount(info.getDouble(2));
				//temp.setSubmitterid(u);
				//temp.setStatusid(info.);
				reimburse.add(temp);
			}
		}catch(SQLException e){
			e.printStackTrace();
		}
		return reimburse;
	}



	
	@Override
	public int userLogin(String email, String pass) throws ClassNotFoundException {
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		try(Connection conn = ConnectionUtil.getConnection()) {
			String sql = "SELECT * FROM USERS WHERE email = ? AND password = ?";// AND U_isAManager = 1" ;
			pstmt = conn.prepareStatement(sql);
			pstmt.setString(1, email);
			pstmt.setString(2, pass);
			rs = pstmt.executeQuery();
			rs.next();
			if(rs == null){
				System.out.println(rs.getString("email"));
            	return 0;
            }
			System.out.println(rs.getString("email"));
			return Integer.parseInt(rs.getString("userid"));
		} catch(SQLException e) {
			e.printStackTrace();	
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
			if (rs != null) {
        			try { rs.close(); } catch(SQLException e) { e.printStackTrace(); }
        		}
		 }     
		return 0;
	}
	@Override
	public boolean register(String username, String password, String email) {
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		try(Connection conn = ConnectionUtil.getConnection()) {
			String sql;
			sql = "SELECT * FROM USERS WHERE U_USERNAME = ?";
			pstmt = conn.prepareStatement(sql);
			pstmt.setString(1, username);
			rs = pstmt.executeQuery();
			if(rs.next()) {
				return false;
			}
			sql = "BEGIN PR_CREATE_USER2(?, ?, ?); END;";
			pstmt = conn.prepareStatement(sql);
			pstmt.setString(1, username);
			pstmt.setString(2, password);
			pstmt.setString(3, email);
			pstmt.executeQuery();
			return true;
		} catch(SQLException e) {
			e.printStackTrace();
			return false;
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
			if (rs != null) {
        			try { rs.close(); } catch(SQLException e) { e.printStackTrace(); }
        		}
		 }
	}

	@Override
	public boolean submitRequest(Reimbursement reimbursement) {
		PreparedStatement pstmt = null;
		try(Connection conn =  ConnectionUtil.getConnection()) {
			String sql = "INSERT INTO REIMBURSEMENTS VALUES(?,?,?,?,?,?,?)";
			pstmt = conn.prepareStatement(sql);
			pstmt.setInt(1, reimbursement.getReimbursementID());
			pstmt.setDouble(2, reimbursement.getAmount());
			pstmt.setString(3, reimbursement.getDescription());
			pstmt.setTimestamp(4, reimbursement.getDateSubmitted());
			pstmt.setInt(5, reimbursement.getAuthorID());
			pstmt.setInt(6, reimbursement.getTypeID());
			pstmt.setInt(7, reimbursement.getStatusID());
			
			if(pstmt.executeUpdate() == 1) {
				return true;
			}
		} catch(SQLException e) {
			e.printStackTrace();
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
		}
	return false;
	}

	@Override
	public Reimbursement[] viewReimbursement(User user, int reimbursementType) {
		List<Reimbursement> reimbursement = new ArrayList<>();
		PreparedStatement pstmt = null;
		ResultSet rs = null;		
		try(Connection conn = ConnectionUtil.getConnection()){
			String sql = "SELECT * FROM REIMBURSEMENTS WHERE U_ID_AUTHOR = ? AND RT_STATUS = ?";
			pstmt = conn.prepareStatement(sql);
			pstmt.setInt(1, user.getUserid());
			pstmt.setInt(2, reimbursementType);
			rs = pstmt.executeQuery();
			
			while(rs.next()) {
				reimbursement.add(returnReimbursement(rs));
			}
			return reimbursement.toArray(new Reimbursement[reimbursement.size()]);
		} catch(SQLException e) {
			e.printStackTrace();
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
			if (rs != null) {
        			try { rs.close(); } catch(SQLException e) { e.printStackTrace(); }
        		}
		 }     
		return reimbursement.toArray(new Reimbursement[reimbursement.size()]);
	}
	
	public User returnUser(ResultSet rs) throws SQLException {
		return new User( rs.getInt("userid"),rs.getString("firstname"), rs.getString("lastname"), 
				rs.getString("email"), rs.getString("password"), rs.getInt("isAManager"));
	}

	public Reimbursement returnReimbursement(ResultSet rs) throws SQLException {
		return new Reimbursement( rs.getInt("R_ID"), rs.getDouble("R_AMOUNT"), rs.getString("R_DESCRIPTION"),
				                   null, rs.getTimestamp("R_SUBMITTED"), rs.getTimestamp("R_RESOLVED"), 
				                  rs.getInt("U_ID_AUTHOR"), rs.getInt("U_ID_RESOLVER"), rs.getInt("RT_TYPE"),rs.getInt("RT_STATUS"));
	}

	@Override
	public boolean updateInfo(User user) {
		PreparedStatement pstmt = null;
		try(Connection conn = ConnectionUtil.getConnection()){
			String sql = "UPDATE USERS SET  , U_FIRSTNAME = ?, U_LASTNAME = ?, U_EMAIL = ?  = ? WHERE U_ID = ?";
			pstmt = conn.prepareStatement(sql);							
			pstmt.setString(3, user.getFirstName());
			pstmt.setString(4, user.getLastName());
			pstmt.setString(2, user.getPassword());
			pstmt.setString(5, user.getEmail());
			
			
			if(pstmt.executeUpdate() == 1) {
				return true;
			}	
		} catch(SQLException e) {
			e.printStackTrace();
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
		 }   
		return false;
	}

	@Override
	public List<User> viewAllEmployees() {
		List<User> allEmployees = new ArrayList<>();
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		try(Connection conn = ConnectionUtil.getConnection()) {
			String sql = "SELECT * FROM USERS";
			pstmt = conn.prepareStatement(sql);
			rs = pstmt.executeQuery();
			
			while(rs.next()) {
				allEmployees.add(returnUser(rs));
			}
			return allEmployees;
		} catch (SQLException e) {
			e.printStackTrace();
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
			if (rs != null) {
        			try { rs.close(); } catch(SQLException e) { e.printStackTrace(); }
        		}
		}
		return allEmployees;
	}

	@Override
	public Reimbursement[] viewAllReimbursements(int reimbursementType) {
		List<Reimbursement> allReimbursements = new ArrayList<>();
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		try(Connection conn = ConnectionUtil.getConnection()){
			String sql = "SELECT * FROM REIMBURSEMENTS WHERE RT_STATUS = ?";
			pstmt = conn.prepareStatement(sql);
			pstmt.setInt(1, reimbursementType);
			rs = pstmt.executeQuery();
			
			while(rs.next()) {
				allReimbursements.add(returnReimbursement(rs));
			}
			return allReimbursements.toArray(new Reimbursement[allReimbursements.size()]);
		} catch (SQLException e) {
			e.printStackTrace();
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
			if (rs != null) {
        			try { rs.close(); } catch(SQLException e) { e.printStackTrace(); }
        		} 
		}
		return allReimbursements.toArray(new Reimbursement[allReimbursements.size()]);
	}

	@Override
	public boolean handleReimbursementRequests(Reimbursement reimbursement) {
		PreparedStatement pstmt = null;
		try(Connection conn = ConnectionUtil.getConnection()){
			String sql = "UPDATE REIMBURSEMENTS SET RT_STATUS = ?, U_ID_RESOLVER = ?,  R_RESOLVED = ?";
			pstmt = conn.prepareStatement(sql);
			pstmt.setInt(1, reimbursement.getStatusID());
			pstmt.setInt(2, reimbursement.getResolverID());
			pstmt.setTimestamp(3, reimbursement.getDateResolved());
			if(pstmt.executeUpdate() == 1) {
				return true;
			}	
		} catch (SQLException e) {
			e.printStackTrace();
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
		}
		return false;
	}

	@Override
	public User viewSingleEmployee(int user_ID) {
		User user = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		try(Connection conn = ConnectionUtil.getConnection()){
			String sql = "SELECT * FROM USERS WHERE userid = ?";
			pstmt = conn.prepareStatement(sql);
			pstmt.setInt(1, user_ID);
			rs = pstmt.executeQuery();
			
			if(rs.next()) {
				user = returnUser(rs);
				return user;
				
			}
		} catch (SQLException e) {
			e.printStackTrace();
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
			if (rs != null) {
        			try { rs.close(); } catch(SQLException e) { e.printStackTrace(); }
        		} 
		}
		return null;
	}
	@Override
	public String returnUserAsSession(String username, String password) {
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		String returnSession;
		try(Connection conn = ConnectionUtil.getConnection()) {
			String sql = "SELECT * FROM USERS WHERE U_USERNAME = ? AND U_PASSWORD = ?" ;
			pstmt = conn.prepareStatement(sql);
			pstmt.setString(1, username);
			pstmt.setString(2, password);
			rs = pstmt.executeQuery();
			
			if(rs.next()) {
				String u_username = rs.getString("U_USERNAME");
				String u_firstname = rs.getString("U_FIRSTNAME");
				String u_lastname = rs.getString("U_LASTNAME");
				String u_password = rs.getString("U_PASSWORD");
				String u_email = rs.getString("U_EMAIL");
				int u_id = rs.getInt("U_ID");
				returnSession = "sessionStorage.user = \'"+u_username+"\'; sessionStorage.pass = \'"+u_password
						+"\'; sessionStorage.email = \'"+u_email+"\'; sessionStorage.id = \'"+u_id+"\'; sessionStorage.fname = \'" 
						+ u_firstname + "\'; sessionStorage.lname = \'" + u_lastname + "\';";
				return returnSession;	
				} 
			}catch (SQLException e) {
			e.printStackTrace();
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
			if (rs != null) {
        			try { rs.close(); } catch(SQLException e) { e.printStackTrace(); }
        		} 
		}
		return null;
	}
	@Override
	public List<String> returnRList(int userID, boolean isManager) {
		System.out.println("REQUEST FROM ID: " + userID + " FOR REIMBURSEMENTS.");
		List<String> reimbursement = new ArrayList<>();
		PreparedStatement pstmt = null;
		ResultSet rs = null;		
		try(Connection conn = ConnectionUtil.getConnection()){
			String sql = "SELECT * FROM REIMBURSEMENTS";
			if(!isManager) {
				sql=sql+" WHERE U_ID_AUTHOR = ? ORDER BY R_ID";
				pstmt = conn.prepareStatement(sql);
				pstmt.setInt(1, userID);
			} else {
				sql = sql + " ORDER BY R_ID";
				pstmt = conn.prepareStatement(sql);
			}
			rs = pstmt.executeQuery();
			String result;
			if(isManager == true) {
				while(rs.next()) {
					int r_id = rs.getInt("R_ID");
					int status = rs.getInt("RT_STATUS");
					Date submitted = rs.getTimestamp("R_SUBMITTED");
					Date resolved = rs.getTimestamp("R_RESOLVED");
					BigDecimal amount = rs.getBigDecimal("R_AMOUNT");
					String status2 = "";
					switch(status) {
					case(1): status2 = "Pending..."; break;
					case(2): status2 = "Approved"; break;
					case(3): status2 = "Denied."; break;
					}
					result = "<tr>"+
						 "<th>"+r_id+"</th>"+ 
						 "<td>"+status2+"</th>"+
						 "<td>"+submitted+"</td>"+
						 "<td>"+resolved+"</td>"+
						 "<td>"+amount.toString()+"</td>"+
						 "<td><a href=# onclick='approval("+r_id+", true)'>Approve</a> or <a href=# onclick='approval("+r_id+", false)'>Deny</a></td>"+
						 "</tr>";
					reimbursement.add(result);
					}
				return reimbursement;
			}
			if(isManager == false) {
				while(rs.next()) {
					System.out.println("got this far....");
					int r_id = rs.getInt("R_ID");
					int status = rs.getInt("RT_STATUS");
					String status2 = "";
					switch(status) {
					case(1): status2 = "Pending..."; break;
					case(2): status2 = "Approved"; break;
					case(3): status2 = "Denied."; break;
					}
					Date submitted = rs.getTimestamp("R_SUBMITTED");
					Date resolved = rs.getTimestamp("R_RESOLVED");
					BigDecimal amount = rs.getBigDecimal("R_AMOUNT");
					System.out.println(amount.toString());
					result = "<tr>"+
						 "<th>"+r_id+"</th>"+ 
						 "<td>"+status2+"</th>"+
						 "<td>"+submitted+"</td>"+
						 "<td>"+resolved+"</td>"+
						 "<td>"+amount.toString()+"</td>"+
						 "</tr>";
					reimbursement.add(result);
				}
				return reimbursement;
			}
		} catch(SQLException e) {
			e.printStackTrace();
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
			if (rs != null) {
        			try { rs.close(); } catch(SQLException e) { e.printStackTrace(); }
        		}
		 }     
		return null;
	}
	public boolean submitFields(int userID, double amount, String desc) {
		PreparedStatement pstmt = null;
		try(Connection conn = ConnectionUtil.getConnection()) {
			String sql;
			sql = "BEGIN PR_CREATE_REIMB(?, ?, ?); END;";
			pstmt = conn.prepareStatement(sql);
			pstmt.setDouble(1, amount);
			pstmt.setString(2, desc);
			pstmt.setInt(3, userID);
			pstmt.executeQuery();
			return true;
		} catch(SQLException e) {
			e.printStackTrace();
			return false;
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
		 }
	}
	public boolean approveall() {
		PreparedStatement pstmt = null;
		try(Connection conn = ConnectionUtil.getConnection()) {
			String sql;
			sql = "BEGIN BETA_APPROVE_ALL; END;";
			pstmt = conn.prepareStatement(sql);
			pstmt.executeQuery();
			return true;
		} catch(SQLException e) {
			e.printStackTrace();
			return false;
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
		 }
	}
	public boolean denyall() {
		PreparedStatement pstmt = null;
		try(Connection conn = ConnectionUtil.getConnection()) {
			String sql;
			sql = "BEGIN BETA_DENY_ALL; END;";
			pstmt = conn.prepareStatement(sql);
			pstmt.executeQuery();
			return true;
		} catch(SQLException e) {
			e.printStackTrace();
			return false;
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
		 }
	}
	public boolean statuschange(String RID, String UID, int status) {
		PreparedStatement pstmt = null;
		try(Connection conn = ConnectionUtil.getConnection()) {
			String sql;
			sql = "BEGIN PR_APPROVE_REIMB(?,?,?); END;";
			pstmt = conn.prepareStatement(sql);
			pstmt.setInt(1, Integer.parseInt(RID));
			pstmt.setInt(2, Integer.parseInt(UID));
			pstmt.setInt(3, status);
			pstmt.executeQuery();
			return true;
		} catch(SQLException e) {
			e.printStackTrace();
			return false;
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
		 }
	}
	public void addname(String fname, String lname, String Username, String Password) {
		PreparedStatement pstmt = null;
		try(Connection conn = ConnectionUtil.getConnection()) {
			String sql;
			sql = "UPDATE USERS SET U_FIRSTNAME = ?, U_LASTNAME = ? WHERE U_USERNAME = ? AND U_PASSWORD = ?";
			pstmt = conn.prepareStatement(sql);
			pstmt.setString(1, fname);
			pstmt.setString(2, lname);
			pstmt.setString(3, Username);
			pstmt.setString(4, Password);
			pstmt.executeQuery();
		} catch(SQLException e) {
			e.printStackTrace();
		} finally { 
			if (pstmt != null) {
				try { pstmt.close(); } catch(SQLException e) { e.printStackTrace(); } 
				}
		 }
	}
}
