package com.bank.main;

import java.math.BigDecimal;
import java.util.Scanner;

import com.bank.dao.DaoTextImpl;
import com.bank.pojos.Account;
import com.bank.pojos.Account.accountType;
import com.bank.pojos.Clerk;
import com.bank.pojos.Person;
import com.bank.pojos.User;
import com.bank.service.Service;

/*
 * Requirements:
 * 	User can...
 * 		- login
 * 		- create an account
 * 		- logout
 * 		- withdraw or deposit funds
 * 		- view own account balance
 * 		- edit own information
 * 
 * Tech Specs
 * 	- core java, file i/o
 */

public class RunBank {

	private static Scanner scan = new Scanner(System.in);
	private static Service bankService = new Service();
	// Keeps track of the account currently logged into the system
	private static Account accountLoggedIn = null;;

	private static String bankName = "GoldenStar Bank Inc.";

	// Implementation to actually run bank application
	public static void main(String[] args) {

		//		// FIXME DEBUG only
		//				createPeopleAndStuff();
		//		// FIXME DEBUG only
		//		readAndWritePersons();

		System.out.println("Hello. Welcome to the automating banking system for " +
				bankName);

		bankingSystem();

		System.out.println("Thank you for using the automating banking system. Have a wonderful day.");

		scan.close();

	}

	private static void bankingSystem() {

		bankloop:
			while (true) {
				System.out.println();	// Formatting
				if (accountLoggedIn != null)
					displayBasicAccountInfo();
				System.out.println("Please choose one of the following commands:");
				System.out.println("login, logout, create account, withdraw, deposit, view account, edit account, quit");

				String input = "";		// used in a few of the case statements
				switch(scan.nextLine().toLowerCase()) {
				case "login":
					if (accountLoggedIn != null) {
						System.out.println("A user is already logged in.");
						continue;
					}

					login();

					break;
				case "logout":
					if (accountLoggedIn == null) {
						System.out.println("You must log in before you can log out.");
						continue;
					}

					logout();

					break;
				case "create account":
					if (accountLoggedIn != null) {
						System.out.println("Please log out before creating a new account.");
						continue;
					}

					if (!createAccount())
						System.out.println("Account creation failed.");
					else {
						System.out.print("Account created, welcome to " + bankName);
						System.out.println(" Please log in to view or modify your account.");
					}

					break;
				case "withdraw":
					if (accountLoggedIn == null) {
						System.out.println("You must log in before modifying your account");
						continue;
					}

					System.out.println("Would you like to withdraw from checking or transfer money from checking to savings?");
					input = scan.nextLine();
					if (input.contains("checking"))
						transferFunds(true);
					else if (input.contains("saving"))
						transferFunds(false);
					else System.out.println("Input was not recognized. Valid entries are \"checking\" and \"saving\" in all lower case");

					break;
				case "deposit":
					if (accountLoggedIn == null) {
						System.out.println("You must log in before modifying your account");
						continue;
					}

					System.out.println("Would you like to deposit to checking or to savings?");
					input = scan.nextLine();
					if (input.contains("checking"))
						deposit(true);
					else if (input.contains("saving"))
						deposit(false);
					else System.out.println("Input was not recognized. Valid entries are \"checking\" and \"saving\" in all lower case");

					break;
				case "view account":
					if (accountLoggedIn == null) {
						System.out.println("You must log in before modifying your account");
						continue;
					}

					viewAccount();

					break;
				case "edit account":
					if (accountLoggedIn == null) {
						System.out.println("You must log in before modifying your account");
						continue;
					}

					editAccount();

					break;
				case "quit":
					break bankloop;
				default:
					System.out.println("Command not recognized. Please try again.");
				}	// end case statement

			}	// end bankloop

	}

	private static void displayBasicAccountInfo() {
		System.out.println("Logged in as: " + accountLoggedIn.getUsername() +
				", Account type: " + accountLoggedIn.getType());
	}

	// Returns true if login was successful
	private static void login() {
		System.out.print("Enter username: ");
		String username = scan.nextLine();
		System.out.print("Enter password: ");
		String password = scan.nextLine();

		Account acc = bankService.validateUser(username, password);

		if (acc == null) {
			System.out.println("Login failed, incorrect username and password combination.");
		} else {
			System.out.println("Login successful, welcome " + acc.getUsername());
			accountLoggedIn = acc;
		}
	}

	// Returns true if logout was successful
	private static boolean logout() {

		System.out.println("Logout successful.");
		accountLoggedIn = null;

		return true;
	}

	// Returns true if an account was successfully created
	private static boolean createAccount() {

		// Get information from user to find/create a person
		System.out.print("Enter your first name: ");
		String firstName = scan.nextLine();
		System.out.print("Enter your last name: ");
		String lastName = scan.nextLine();
		System.out.print("Enter your Social Security Number: ");
		String SSN = scan.nextLine();

		Person per = bankService.tryCreatePerson(SSN, firstName, lastName, "");

		// Set email. email is not required to be a person but it
		// is required to have an account
		if (!setEmail(per))
			return false;

		// Get information from user to create an account
		System.out.print("Enter your username: ");
		String username = scan.nextLine();
		System.out.print("Enter your password: ");
		String password = scan.nextLine();

		return bankService.createUser(per, new Account(per, username, password, accountType.BRONZE));
	}

	private static boolean transferFunds(boolean checking) {
		BigDecimal balance = null;
		String accountStr = null;

		if (checking) {
			balance = bankService.getCheckingAccountBalance(accountLoggedIn.getUsername());
			accountStr = "Checking";
		}
		else {		// Savings account
			balance = bankService.getSavingsAccountBalance(accountLoggedIn.getUsername());
			accountStr = "Savings";
		}

		try {

			System.out.print("Current funds: $" + balance.toString() +
					"\nEnter an ammount to be withdrawn from your " + accountStr + " account: ");

			BigDecimal withdrawAmmount = new BigDecimal(scan.nextLine());

			if (withdrawAmmount.abs() != withdrawAmmount) {
				System.out.println("You cannot withdraw a negative quantity.");
				return false;
			}

			switch(balance.compareTo(withdrawAmmount)) {
			case -1:
				System.out.println("You cannot withdraw more than your " + accountStr + " balance");
				return false;
			default:

				User guy = bankService.getUser(accountLoggedIn.getUsername());

				BigDecimal finalBalance = balance.subtract(withdrawAmmount);
				if (checking)
					guy.getAccount().setCheckingBalance(finalBalance);
				else {		// Savings account
					guy.getAccount().setSavingsBalance(finalBalance);
					guy.getAccount().setCheckingBalance(balance.add(withdrawAmmount));
				}

				bankService.updateUser(guy);

				System.out.println("$" + withdrawAmmount.toString() + " withdrawn from " + accountStr);
				System.out.println("$" + guy.getAccount().getCheckingBalance().toString() + " new checking balance");

				return true;
			}

		} catch (NumberFormatException e) {
			System.out.println("Error: That is not a valid withdraw ammount");
			return false;
		}

	}

	// FIXME there should be a maximum limit to how much can be deposited
	private static boolean deposit(boolean checking) {
		BigDecimal balance = null;
		String accountStr = null;

		if (checking) {
			balance = bankService.getCheckingAccountBalance(accountLoggedIn.getUsername());
			accountStr = "Checking";
		}
		else {		// Savings account
			balance = bankService.getSavingsAccountBalance(accountLoggedIn.getUsername());
			accountStr = "Savings";
		}

		try {

			System.out.print("Current funds: $" + balance.toString() +
					"\nEnter an ammount to be deposited to your " + accountStr + " account: ");

			BigDecimal depositAmmount = new BigDecimal(scan.nextLine());

			if (depositAmmount.abs() != depositAmmount) {
				System.out.println("You cannot deposit a negative quantity.");
				return false;
			}

			User guy = bankService.getUser(accountLoggedIn.getUsername());

			BigDecimal finalBalance = balance.add(depositAmmount);
			if (checking)
				guy.getAccount().setCheckingBalance(finalBalance);
			else 		// Savings account
				guy.getAccount().setSavingsBalance(finalBalance);

			if (!bankService.updateUser(guy)) {
				System.out.println("Transaction failed.");
				return false;
			}

			System.out.println("$" + depositAmmount.toString() + " deposited to " + accountStr);
			System.out.println("$" + guy.getAccount().getCheckingBalance().toString() + " new checking balance");

			return true;


		} catch (NumberFormatException e) {
			System.out.println("Error: That is not a valid withdraw ammount");
			return false;
		}
	}
	private static boolean viewAccount() {

		System.out.println(accountLoggedIn.toString());

		return true;
	}
	private static boolean editAccount() {

	}

	// Returns false if a valid email was not supplied
	private static boolean setEmail(Person per) {

		// get email
		System.out.println("Enter your email address");
		String email = scan.nextLine();

		if (bankService.isEmailValid(email))
			if (bankService.isEmailAvailable(email)) {
				per.setEmail(email);
				bankService.updatePerson(per);
				return true;
			}

		return false;
	}

	// FIXME DEBUG only
	private static void createPeopleAndStuff() {
		DaoTextImpl daoImpl = new DaoTextImpl();

		Person per1;

		per1 = new Person("123456789", "first", "last");
		per1.setEmail("person1@mail.com");
		Person per2 = new Person("987654321", "clerkFirst", "clerkLast");
		per2.setEmail("person2@mail.com");
		Account acc = new Account(per1, "username", "password", accountType.BRONZE);
		User myUser = new User(per1, acc);
		Clerk cler = new Clerk(per2);

		daoImpl.createUser(myUser);
		daoImpl.createClerk(cler);


	}

	// FIXME DEBUG only
	private static void readAndWritePersons() {

		Person per1 = bankService.tryCreatePerson("123456432", "first", "last", "email@mail.com");
		Person per2 = bankService.tryCreatePerson("76542335", "first", "last", "myemail@mail.com");

		Account acc1 = new Account(per1, "username", "password", accountType.BRONZE);
		Account acc2 = new Account(per2, "uniqueUsername", "password", accountType.BRONZE);
		bankService.createUser(per1, acc1);
		bankService.createUser(per2, acc2);

		Account loggedIn = bankService.validateUser("username", "password");

	}

}
